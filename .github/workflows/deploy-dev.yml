name: Deploy Backend Dev

on:
  push:
    branches: ["develop"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Pull repository code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2) Install ZIP tool on GitHub runner
      - name: Install Zip
        run: sudo apt-get install zip -y

      # 3) Create backend.zip excluding unwanted files
      - name: Zip Backend
        run: zip -r backend.zip . -x "vendor/*" ".git/*" ".github/*"

      # 4) Debug: show workspace files
      - name: Debug workspace files
        run: ls -la .

      # 5) Upload backend.zip → server
      - name: Upload Backend Zip
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}   # MUST be root
          key: ${{ secrets.DEV_SSH_KEY }}
          source: "./backend.zip"
          target: "/var/www/backend/"
          strip_components: 0
          overwrite: true

      # 6) Debug: check if file is on server
      - name: Check server folder
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "Files in /var/www/backend:"
            ls -la /var/www/backend

      # 7) Deploy backend on server
      - name: Deploy Backend on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}   # root
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e

            cd /var/www/backend

            # Ensure unzip exists
            command -v unzip >/dev/null 2>&1 || sudo apt install unzip -y

            # Check zip file
            if [ ! -f backend.zip ]; then
              echo "backend.zip NOT found on server — SCP failed"
              exit 1
            fi

            # Delete everything except storage/
            find . -mindepth 1 -maxdepth 1 ! -name storage -exec rm -rf {} +

            # Extract new source
            unzip -o backend.zip
            rm backend.zip

            # Install Laravel dependencies
            composer install --no-dev --prefer-dist

            # Laravel framework setup
            cp .env.example .env || true
            php artisan key:generate || true
            php artisan config:cache
            php artisan route:cache
            php artisan migrate --force

            # Fix permissions
            sudo chown -R www-data:www-data /var/www/backend
            sudo chmod -R 755 /var/www/backend/storage
            sudo chmod -R 755 /var/www/backend/bootstrap/cache

            echo "Backend Deployment complete!"
